version: 2.1

orbs:
  node: circleci/node@5.1.0

jobs:
  build_and_scan:
    docker:
      - image: cimg/node:20.11
    environment:
      CI: "true"
    steps:
      - checkout

      # Restore npm cache based on package-lock.json
      - restore_cache:
          keys:
            - v1-npm-{{ checksum "package-lock.json" }}
            - v1-npm-

      # Install dependencies (reproducible)
      - run:
          name: Install dependencies
          command: |
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm i
            fi

      # Save cache for future runs
      - save_cache:
          key: v1-npm-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
            - node_modules

      # Lint / Build (dont fail pipeline on lint yet)
      - run: npm run lint || true
      - run: npm run build

      # Download SonarScanner CLI
      - run:
          name: Download SonarScanner CLI
          command: |
            curl -sSLo /tmp/sonar-scanner.zip \
              https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-5.0.1.3006-linux.zip
            unzip -q /tmp/sonar-scanner.zip -d /tmp
            echo 'export PATH="/tmp/sonar-scanner-5.0.1.3006-linux/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV

      # Run SonarCloud scan (reads sonar-project.properties)
      - run:
          name: Run SonarCloud scan
          command: |
            if [ -z "$SONAR_TOKEN" ]; then
              echo "Missing SONAR_TOKEN env var in CircleCI project settings"; exit 1;
            fi
            sonar-scanner -Dsonar.login="$SONAR_TOKEN"

workflows:
  build_and_scan_every_push:
    jobs:
      - build_and_scan:
          filters:
            branches:
              only: /.*/
