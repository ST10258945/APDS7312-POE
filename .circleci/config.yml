version: 2.1

orbs:
  node: circleci/node@5.1.0

jobs:
  build_and_scan:
    docker:
      - image: cimg/node:20.11
    environment:
      CI: "true"
    steps:
      - checkout

      # Restore npm cache
      - restore_cache:
          keys:
            - v1-npm-{{ checksum "package-lock.json" }}
            - v1-npm-

      # Install dependencies
      - run:
          name: Install dependencies
          command: |
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm i
            fi

      # Save cache
      - save_cache:
          key: v1-npm-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
            - node_modules

      # Lint & build
      - run: npm run lint || true
      - run: npm run build

      # Run SonarCloud scan via Node client (reads sonar-project.properties)
      - run:
          name: Run SonarCloud scan
          command: |
            if [ -z "$SONAR_TOKEN" ]; then
              echo "Missing SONAR_TOKEN environment variable in CircleCI project settings"; exit 1;
            fi
            npm run sonar:ci

workflows:
  build_and_scan_every_push:
    jobs:
      - build_and_scan:
          filters:
            branches:
              only: /.*/
