version: 2.1

orbs:
  node: circleci/node@5.1.0

jobs:
  build_and_scan:
    docker:
      - image: cimg/node:20.11
    environment:
      CI: "true"
    steps:
      - checkout

      # Restore npm cache based on package-lock.json
      - restore_cache:
          keys:
            - v1-npm-{{ checksum "package-lock.json" }}
            - v1-npm-

      # Install dependencies
      - run:
          name: Install dependencies
          command: |
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm i
            fi

      # Save cache for future runs
      - save_cache:
          key: v1-npm-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
            - node_modules

      # Lint & build (lint is non-blocking; build must pass)
      - run: npm run lint || true
      - run: npm run build

      # Install Java (SonarScanner requires a JRE)
      - run:
          name: Install OpenJDK 17 (headless)
          command: |
            sudo apt-get update
            sudo apt-get install -y openjdk-17-jre-headless
            java -version

      # Download SonarScanner CLI (GitHub Releases with fallback)
      - run:
          name: Download SonarScanner CLI
          command: |
            set -e
            # Primary (GitHub Releases) â€“ tends to avoid 403s seen on the CDN
            GH_URL="https://github.com/SonarSource/sonar-scanner-cli/releases/download/v5.0.1.3006/sonar-scanner-5.0.1.3006-linux.zip"
            CDN_URL="https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-5.0.1.3006-linux.zip"
            for URL in "$GH_URL" "$CDN_URL"; do
              echo "Attempting download: $URL"
              if curl -sSfL -o /tmp/sonar-scanner.zip "$URL"; then
                break
              else
                echo "Download failed from $URL; trying next source..."
              fi
            done
            unzip -q -o /tmp/sonar-scanner.zip -d /tmp
            SC_DIR="$(find /tmp -maxdepth 1 -type d -name 'sonar-scanner-*-linux' | head -n 1)"
            if [ -z "$SC_DIR" ]; then echo "SonarScanner directory not found"; exit 1; fi
            echo "export PATH=\"$SC_DIR/bin:\$PATH\"" >> "$BASH_ENV"
            source "$BASH_ENV"
            sonar-scanner --version

      # Run SonarCloud scan (uses sonar-project.properties)
      - run:
          name: Run SonarCloud scan
          command: |
            if [ -z "$SONAR_TOKEN" ]; then
              echo "Missing SONAR_TOKEN environment variable in CircleCI project settings"; exit 1;
            fi
            sonar-scanner -Dsonar.login="$SONAR_TOKEN"

workflows:
  build_and_scan_every_push:
    jobs:
      - build_and_scan:
          filters:
            branches:
              only: /.*/
